---
title: "simple example simulation"
author: "Siyue Yang"
date: "19/02/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(matrixStats)
library(kableExtra)

gen_dat <- function(N, label.size, beta, nsim = 5000, eps_sd = 0.5) {
  sl <- c()
  ssl <- c()
  ase_ssl <- c()
  for (nn in c(1:nsim)) {
    # generate Y = beta * X + eps, Y ~ N(0,1), eps ~ N(0, 0.5)
    set.seed(1234 + nn)
    x <- rnorm(N, 0, 1)
    eps <- rnorm(N, mean=0, sd=0.5)
    y = beta*x + eps
    
    # calculate SL
    x.lab <- x[1: label.size]
    y.lab <- y[1: label.size]
    mod <- lm(y.lab ~ x.lab)
    sl <- c(sl, mean(y.lab))
    
    # calcualte SSL
    x.unlab <- x[(label.size+1):length(y)]
    y.unlab <- y[(label.size+1):length(y)]
    # m estimator
    mx <- summary(mod)$coef[1,1] + summary(mod)$coef[2,1] * x.unlab
    ssl <- c(ssl, mean(mx))
    
    # calcualte the ASE
    ase_ssl <- c(ase_ssl, sd(y.unlab - beta*x.unlab))
  }
  return(list(sl = sl, ssl = ssl, ase_ssl = ase_ssl))
}
```

```{r}
bias_variance_cal <- function(theta, mu) {
  mean <- mean(theta)
  bias <- mean - mu
  ese <- sd(theta)
  mse <- mean((theta - mu)^2)
  return(c(mean, bias, ese, mse))
}
```


```{r}
run_sim <- function(N, label.size, beta, mu, nsim = 5000, eps_sd = 0.5) {
  dat <- gen_dat(N, label.size, beta)
  sl <- dat$sl
  ssl <- dat$ssl
  properties_sl <- bias_variance_cal(sl, mu)
  properties_ssl <- bias_variance_cal(ssl, mu)
  ase <- mean(dat$ase_ssl)
  efficiency <- properties_sl[4]/properties_ssl[4]
  return(c(properties_sl, properties_ssl, ase, efficiency))
}
```


```{r}
# Setting 1: compare n = 100, 200, 400
lab_100_beta_0.5 <- run_sim(10000, 100, 0.5, 0)
lab_200_beta_0.5 <- run_sim(10000, 200, 0.5, 0)
lab_400_beta_0.5 <- run_sim(10000, 400, 0.5, 0)
```

```{r}
table1 <- rbind(lab_100_beta_0.5, lab_200_beta_0.5, lab_400_beta_0.5)
rownames(table1) <- c(100, 200, 400)
colnames(table1) <- c("SL", "bias", "ESE", "MSE", "SSL", "Bias", "ESE", "MSE", "ASE", "EFficiency")

table1 <- cbind(table1)
table1 <- round(table1, 4)

kableExtra::kbl(table1, booktabs = T, caption="Efficiencies wrt. empirical mean square error for m(x) = 0.5x") %>% 
  add_header_above(c(" ", "Supervised learning estimator"=4, "Semi-supervised estimator"=5, " ")) %>%
  kable_styling(latex_options = c("scale_down", "hold_position")) 
```


```{r}
# Setting 2: N=10000 down to n = 100
r <- c()
for (i in seq(100, 10000, 100)) {
  r <- rbind(r, (run_sim(i, 100, 0.5, 0, nsim = 1000)))
}
```

```{r}
library(ggplot2)
Efficiency <- r[, 10]
Efficiency[1] <- 1

data.frame(index = seq(100, 10000, 100), eff = Efficiency) %>%
  ggplot() + geom_line(aes(index, eff))  + 
  ylab("Relative efficiency (SL:SSL)") + xlab("Unlabeled sample size N") + 
  ggtitle("N = 100 to N = 100000") + theme_bw()

```

```{r}
ase <- r[, 9]
ese <- r[, 7]

data.frame(index = seq(100, 10000, 100), ase = ase, ese = ese) %>%
  ggplot() + geom_line(aes(index, ase))  + geom_line(aes(index, ese)) + 
  ylab("Relative efficiency (SL:SSL)") + xlab("Unlabeled sample size N") + 
  ggtitle("N = 100 to N = 100000") + theme_bw()

```


```{r}
# Setting 3: compare m(x) = 0.5 and m(x) = 2
lab_400_beta_2 <- run_sim(10000, 400, 2, 0)
```

```{r}
table3 <- rbind(lab_400_beta_0.5, lab_400_beta_2)
rownames(table3) <- c("m(x) = 0.5x", "m(x) = 2x")
colnames(table3) <- c("SL", "bias", "ESE", "MSE", "SSL", "Bias", "ESE", "MSE", "ASE", "EFficiency")


kableExtra::kbl(table3, booktabs = T, caption="Compare m = 0.5x and m(x) = 2x") %>% 
  add_header_above(c(" ", "Supervised learning estimator"=4, "Semi-supervised estimator"=5, " ")) %>%
  kable_styling(latex_options = c("scale_down", "hold_position")) 
```




















